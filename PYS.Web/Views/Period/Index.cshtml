@using PYS.Core.Application.Features.FormTypesFeature.Dtos
@using PYS.Core.Application.Features.PeriodsFeature.Dtos
@using PYS.Web.Services
@using PYS.Web.ViewModels.Period
@model PeriodViewModel
@section Scripts {
    <script>
        let selectedEmployees = [];

        function openCreateModal() {
          debugger;
          
           $('#periodId').val('');
           $('#modalSubmitButton').text('Kaydet');
           $('#periodForm').attr('action', '/Period/Create');
           $('#modal-title').text('Yeni Dönem Ekle');

           appendYearForPeriodModal();
           
           
           $('#periodModal').modal('show');
        }

        //dönem ekleme yıllarını getirme -> today + 10 yıl
        function appendYearForPeriodModal(){
           var currentYear = new Date().getFullYear();
           var $yearSelect = $('#yearSelect');

            $yearSelect.empty();

           for (var i = 0; i <= 10; i++) {
               var year = currentYear + i;
               $yearSelect.append($('<option>', {
                   value: year,
                   text: year
               }));
           }

        }

        //seçilen dönemi modal'da açma -< güncelleme için
        function openEditModal(id) {
            console.log("openEditModal çalıştı");
            $.ajax({
                url: '/Period/GetPeriodById?id=' + id,
                type: 'GET',
                success: function (data) {
                    debugger;

                    $('#modal-title').text('Dönem Güncelle');

                    $('#periodForm').attr('action', '/Period/UpdatePeriod');

                    appendYearForPeriodModal();

                    $('#periodId').val(data.id);
                    $('#yearSelect').val(data.year);
                    $('#termSelect').val(data.term);
                    $('#startDate').val(data.startDate.split('T')[0]);
                    $('#endDate').val(data.endDate.split('T')[0]);

                    $('#stagingYes').prop('checked', data.hasStaging == 1);
                    $('#stagingNo').prop('checked', data.hasStaging == 0);


                    $("input[name='FormTypeIds']").prop('checked', false);
                    data.formTypeIds.forEach(function (id) {
                        $("input[name='FormTypeIds'][value='" + id + "']").prop('checked', true);
                    });

                    $("input[name='LocationIds']").prop('checked', false);
                    data.locationIds.forEach(function (id) {
                        $("input[name='LocationIds'][value='" + id + "']").prop('checked', true);
                    });

           
                    $('#periodModal').modal('show');
                }
            });
        }

        function openAddEmployeeModal(periodId,year,term) {
            debugger;
            $("#employeePeriodId").val(periodId);
            $("#employeePeriodText").val(year +'-'+ term);
            
            //döneme daha öncden eklenmiş mi
            checkAndOpenModal(periodId);
        }

        //Döneme kişi eklenmiş mi kontrol, eklendiyse işlem yapılmıyor
        function checkAndOpenModal(periodId) {
            debugger;
            $.ajax({
                url: '/Period/CheckUsersForPeriod',
                type: 'GET',
                data: { periodId: periodId },
                success: function (hasData) {
                    debugger;
                    if (hasData.length > 0) {
                        debugger;
                        toastr.warning(" Bu döneme ait kullanıcılar zaten eklenmiş.");
                         $('#userSelectModal').modal('hide');
                    } else {
                        $('#userSelectModal').modal('show');
                    }
                }
            });
        }

        //Kişi eklerken tarihe göre kişiler SAP'den getirme
        function fetchEmployees() {
            debugger;
          const date = $('#employeeStartDate').val();
          if (!date) {
            toastr.warning("Lütfen bir tarih seçiniz.");
            return;
          }

          $.ajax({
            url: `/Period/GetEmployeesByStartDate?date=${date}`,
            type: 'GET',
            success: function (data) {
                debugger;
              const container = $('#employeeListContainer');
              container.empty();
              //console.log(data);
              if (data.length === 0) {
                container.append('<p class="text-muted">Kriterlere uygun kişi bulunamadı.</p>');
                return;
              }
              let periodId = $("#employeePeriodId").val();
              let periodText = $("#employeePeriodText").val();


              const table = $(' <input type="text" id="searchInput" class="form-control mb-2" placeholder="Çalışan ara..."> <table class="table table-sm table-bordered"><thead><tr><th> <input class="form-check-input" type="checkbox" id="selectAllCheckbox"></th><th>Ad Soyad</th><th>PerNr</th><th>Departman</th></tr></thead><tbody id="employeeTableBody"></tbody></table>');
              data.forEach(emp => {
                  debugger;
                table.find('tbody').append(`
                  <tr data-employee='{"PeriodId":"${periodId}","PeriodText":"${periodText}","PerNr":"${emp.pernr}","Ename":"${emp.ename}","Persg":"${emp.persg}","Persk":"${emp.persk}","OID":"${emp.oid}","Orgtx":"${emp.orgtx}","SID":"${emp.sid}","PLSTX":"${emp.plstx}","Mail":"${emp.mail}","MPernr":"${emp.mPernr}","MMail":"${emp.mMail}","AccAsgmnt":"${emp.accAsgmnt}","AccAsgmntT":"${emp.accAsgmntT}","Level":"${emp.kademe?.trim() ? emp.kademe : 0}"}'>
                    <td><input type="checkbox" class="employee-checkbox" value="${emp.id}" /></td>
                    <td>${emp.ename}</td>
                    <td>${emp.pernr}</td>
                    <td>${emp.orgtx}</td>
                  </tr>
                `);
              });

              container.append(table);
            },
            error: function () {
              toastr.error("Kişiler alınırken hata oluştu.");
            }
          });
        }
        
        //Kişi ekleme'de arama
        $(document).on('keyup', '#searchInput', function () {
            debugger;
           const value = $(this).val().toLowerCase();
           $('#employeeTableBody tr').filter(function () {
           $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
        });
        });

        //Kişi ekleme checkbox seçimi
        $(document).on('change', '#selectAllCheckbox', function () {
           const isChecked = $(this).is(':checked');
           $('.employee-checkbox').prop('checked', isChecked);
        });

        //döeneme kişi ekleme
        $("#saveSelectedEmployees").click(function(){
            debugger;
            selectedEmployees = [];
             $('.employee-checkbox:checked').each(function () {
              const employeeData = $(this).closest('tr').data('employee');
              selectedEmployees.push(employeeData);
            });

           const payload = {
            PeriodId: $('#employeePeriodId').val(),
            PeriodText:  $("#employeePeriodText").val(),
            users: selectedEmployees
        };

        $.ajax({
            url: '/Period/AddUsersToPeriod',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function (response) {
                toastr.success(response.message || 'Kullanıcılar başarıyla eklendi.');
            },
            error: function (xhr) {
                toastr.error(xhr.responseJSON?.message || 'Hata oluştu.');
            }
        });
        });

        //Dönemi Silme
        function confirmDelete(id) {
            Swal.fire({
                title: 'Emin misin?',
                text: "Bu dönemi silmek üzeresin!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Evet, sil',
                cancelButtonText: 'Hayır',
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d'
            }).then((result) => {
                if (result.isConfirmed) {
                    $('#deleteForm-' + id).submit();
                }
            });
        }

    </script>
}

<h4 class="fw-bold py-3 mb-4">
    <span class="text-muted fw-light">IK Yönetim Paneli /</span> Dönem Listesi 
</h4>


<!-- Hoverable Table rows -->
<div class="card">


    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Dönemler</h5>
      
        <a href="javascript:void(0);" class="btn btn-sm btn-primary" data-bs-toggle="modal"
           data-bs-target="#periodModal" onclick="openCreateModal()">
            <i class="bx bx-plus"></i> Dönem Ekle
        </a>
    </div>
    <div class="table-responsive text-nowrap">
        <table class="datatables-basic table border-top dataTable no-footer dtr-column" id="dataTable">
            <thead>
                <tr>
                    <th>Yıl</th>
                    <th>Dönem</th>
                    <th>Başlangıç Tarihi</th>
                    <th>Bitiş Tarihi</th>
                    <th>Durum</th>
                    <th>İşlem</th>

                </tr>
            </thead>
            <tbody class="table-border-bottom-0">

                @foreach (var period in Model.Periods)
                {
                    string statu = period.IsActive ? "Aktif" : "Pasif";
                    string statuClass = period.IsActive ? "success" : "warning";
                    <tr name="@period.Id">

                        <td>@period.Year</td>
                        <td>@period.Term</td>
                        <td>@period.StartDate.ToString("dd.MM.yyyy")</td>
                        <td>@period.EndDate.ToString("dd.MM.yyyy")</td>
                        <td>
                            <span class="badge bg-label-@statuClass me-1">@statu</span>
                        </td>
                        <td>
                            <div class="dropdown">
                                <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
                                    <i class="bx bx-dots-vertical-rounded"></i>
                                </button>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item" onclick="openEditModal('@period.Id')"><i class="bx bx-edit-alt me-1"></i> Dönem Bilgilerini Güncelle</a>
                                    <a class="dropdown-item" onclick="openAddEmployeeModal('@period.Id','@period.Year','@period.Term')" ><i class="bx bx-edit-alt me-1"></i> Kişileri Ata</a>
                                    <a asp-controller="Period" asp-action="TreeViewPeriod" asp-route-periodId="@period.Id" asp-route-periodYear="@period.Year" asp-route-periodTerm="@period.Term" class="dropdown-item"><i class="bx bx-edit-alt me-1"></i> Ağaç Yapısı</a>
                                    <a asp-controller="Period" asp-action="DataTablePeriod" asp-route-periodId="@period.Id" asp-route-periodYear="@period.Year" asp-route-periodTerm="@period.Term" class="dropdown-item"><i class="bx bx-edit-alt me-1"></i> Tablo Yapısı</a>


                                   @*  <form asp-controller="Period" asp-action="DeletePeriod" method="post" style="display:inline;">
                                        <input type="hidden" name="id" value="@period.Id" />
                                        <button type="submit" class="dropdown-item" onclick="return confirm('Silmek istediğine emin misin?')">
                                            <i class="bx bx-trash me-1"></i> Dönemi Sil
                                        </button>
                                    </form> *@

                                    <button type="button" class="dropdown-item" onclick="confirmDelete('@period.Id')">
                                        <i class="bx bx-trash me-1"></i> Dönemi Sil
                                    </button>

                                    <form id="deleteForm-@period.Id" asp-controller="Period" asp-action="DeletePeriod" method="post" style="display:none;">
                                        <input type="hidden" name="id" value="@period.Id" />
                                    </form>
                                </div>
                            </div>
                        </td>

                    </tr>
                }    

            </tbody>
        </table>
    </div>
</div>
<!--/ Hoverable Table rows -->
<!-- Dönem Ekleme Modal -->
<div class="modal fade" id="periodModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <form id="periodForm" method="post"> 
            <!-- Form Post -->
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-title">Dönem Ekle</h5>
                    <input type="hidden" id="periodId" name="Id" value="" />
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label for="yearSelect" class="form-label">Yıl</label>
                        <select class="form-select" id="yearSelect" name="Year">
                                             
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Dönem</label>
                        <select class="form-select" id="termSelect" name="Term">
                            <option value="Yıl Sonu">Yıl Sonu</option>
                            <option value="Ara Dönem">Ara Dönem</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Form Tipleri</label>

                        <div class="col-md">
                           
                            @foreach (var formType in Model.FormTypes)
                            {
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="FormTypeIds" value="@formType.Id" id="@formType.Id">
                                    <label class="form-check-label" for="@formType.Id">@formType.FormTypeName</label>


                                </div>
                            }
                        </div>

                    </div>
                    <div class="mb-3">
                        <label class="form-label">Lokasyon</label>
                        @foreach (var locations in Model.Locations)
                        {
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="LocationIds" value="@locations.Id" id="@locations.Id">
                                <label class="form-check-label" for="@locations.Id">@locations.Name</label>


                            </div>
                        }
                    </div>
                 
                    <div class="mb-3">
                        <label class="form-label">Kademelendirme</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="HasStaging" id="stagingYes" value="true">
                            <label class="form-check-label" for="stagingYes">Var</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="HasStaging" id="stagingNo" value="false">
                            <label class="form-check-label" for="stagingNo">Yok</label>
                        </div>
                    </div>

                    <div class="row g-2">
                        <div class="col">
                            <label for="startDate" class="form-label">Dönem Başlangıç</label>
                            <input type="date" class="form-control" name="StartDate" id="startDate">
                        </div>
                        <div class="col">
                            <label for="endDate" class="form-label">Dönem Bitiş</label>
                            <input type="date" class="form-control" name="EndDate" id="endDate">
                        </div>
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" id="modalSubmitButton">Kaydet</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Döneme Kişi Ekleme Modal -->

<div class="modal fade" id="userSelectModal" tabindex="-1" aria-labelledby="userSelectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Kişi Ekle</h5>
                <input type="hidden" id="employeePeriodId">
                <input type="hidden" id="employeePeriodText">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>

            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="startDate">Dönem Baz Tarihi</label>
                        <input type="date" id="employeeStartDate" class="form-control" />
                    </div>
                    <div class="col-md-4 align-self-end">
                        <button class="btn btn-primary" onclick="fetchEmployees()">Kişileri Getir</button>
                    </div>
                </div>

                <div id="employeeListContainer" class="mt-3" style="max-height: 400px; overflow-y: auto;">
                    <!-- AJAX ile kişiler buraya gelecek -->
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                <button type="button" class="btn btn-success saveSelectedEmployees" id="saveSelectedEmployees">Kaydet</button>
            </div>

        </div>
    </div>
</div>
