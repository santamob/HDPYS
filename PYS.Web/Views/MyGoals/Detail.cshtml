@using PYS.Web.Services
@using PYS.Core.Domain.Enums
@model PYS.Core.Application.Features.EmployeeGoalFeature.Dtos.EmployeeGoalDto
@{
    ViewData["Title"] = "Hedef Detayı";
    var statusClass = Model.Status switch
    {
        GoalStatus.Draft => "secondary",
        GoalStatus.PendingFirstApproval => "warning",
        GoalStatus.PendingSecondApproval => "info",
        GoalStatus.Approved => "success",
        GoalStatus.Rejected => "danger",
        _ => "secondary"
    };
}

<h4 class="fw-bold py-3 mb-4">
    <span class="text-muted fw-light"><a asp-action="Index">Hedeflerim</a> /</span> Hedef Detayı
</h4>

<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0"><i class="bx bx-target-lock me-2"></i>@Model.GoalTitle</h5>
                <span class="badge bg-label-@statusClass">@Model.StatusText</span>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label text-muted small">Dönem</label>
                        <p class="fw-medium">@Model.PeriodName</p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small">Gösterge</label>
                        <p class="fw-medium">@(Model.IndicatorName ?? "Manuel Hedef")</p>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(Model.GoalDescription))
                {
                    <div class="mb-3">
                        <label class="form-label text-muted small">Açıklama</label>
                        <p>@Model.GoalDescription</p>
                    </div>
                }

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label text-muted small">Hedef Değer</label>
                        <p class="fw-medium">@Model.TargetValue @Model.TargetUnit</p>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-muted small">Ağırlık</label>
                        <p class="fw-medium">%@Model.Weight</p>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-muted small">Gerçekleşen Değer</label>
                        <p class="fw-medium">@(Model.ActualValue?.ToString() ?? "-")</p>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label text-muted small">Başarı Oranı</label>
                        <p class="fw-medium">@(Model.AchievementRate.HasValue ? $"%{Model.AchievementRate}" : "-")</p>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-muted small">Hesaplanan Puan</label>
                        <p class="fw-medium">@(Model.CalculatedScore?.ToString() ?? "-")</p>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-muted small">Ağırlıklı Puan</label>
                        <p class="fw-medium">@(Model.WeightedScore?.ToString() ?? "-")</p>
                    </div>
                </div>

                @if (Model.StartDate.HasValue || Model.EndDate.HasValue)
                {
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-muted small">Başlangıç Tarihi</label>
                            <p class="fw-medium">@(Model.StartDate?.ToString("dd.MM.yyyy") ?? "-")</p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-muted small">Bitiş Tarihi</label>
                            <p class="fw-medium">@(Model.EndDate?.ToString("dd.MM.yyyy") ?? "-")</p>
                        </div>
                    </div>
                }

                @if (!string.IsNullOrEmpty(Model.EmployeeNote))
                {
                    <div class="mb-3">
                        <label class="form-label text-muted small">Çalışan Notu</label>
                        <p>@Model.EmployeeNote</p>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Sağ Panel -->
    <div class="col-lg-4">
        <!-- Durum Bilgisi -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0"><i class="bx bx-info-circle me-1"></i>Durum Bilgisi</h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Durum</span>
                    <span class="badge bg-label-@statusClass">@Model.StatusText</span>
                </div>
                @if (Model.FirstApprovalDate.HasValue)
                {
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">1. Onay Tarihi</span>
                        <span>@Model.FirstApprovalDate.Value.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</span>
                    </div>
                }
                else if (Model.ApprovalDate.HasValue)
                {
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Onay Tarihi</span>
                        <span>@Model.ApprovalDate.Value.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</span>
                    </div>
                }
                @if (Model.SecondApprovalDate.HasValue)
                {
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">2. Onay Tarihi</span>
                        <span>@Model.SecondApprovalDate.Value.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</span>
                    </div>
                }
                @if (Model.RejectionCount > 0)
                {
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Ret Sayısı</span>
                        <span class="text-danger">@Model.RejectionCount</span>
                    </div>
                }
            </div>
        </div>

        <!-- Yönetici Notu -->
        @if (!string.IsNullOrEmpty(Model.ManagerNote))
        {
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0"><i class="bx bx-comment me-1"></i>1. Yönetici Notu</h6>
                </div>
                <div class="card-body">
                    <p class="mb-0">@Model.ManagerNote</p>
                </div>
            </div>
        }

        <!-- 2. Üst Yönetici Notu -->
        @if (!string.IsNullOrEmpty(Model.SecondManagerNote))
        {
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0"><i class="bx bx-comment-detail me-1"></i>2. Üst Yönetici Notu</h6>
                </div>
                <div class="card-body">
                    <p class="mb-0">@Model.SecondManagerNote</p>
                </div>
            </div>
        }

        <!-- Aksiyonlar -->
        <div class="card">
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a class="btn btn-outline-secondary" asp-action="Index"><i class="bx bx-arrow-back me-1"></i>Geri Dön</a>
                    @if (Model.Status == GoalStatus.Draft || Model.Status == GoalStatus.Rejected)
                    {
                        <a class="btn btn-outline-primary" asp-action="Edit" asp-route-id="@Model.Id"><i class="bx bx-edit me-1"></i>Düzenle</a>
                    }
                    @if (Model.Status == GoalStatus.Draft)
                    {
                        <button class="btn btn-outline-danger btn-delete-goal" data-id="@Model.Id"><i class="bx bx-trash me-1"></i>Sil</button>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $('.btn-delete-goal').on('click', function () {
            var goalId = $(this).data('id');
            Swal.fire({
                title: 'Emin misiniz?',
                text: "Bu hedef kalıcı olarak silinecektir!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Evet, Sil',
                cancelButtonText: 'İptal'
            }).then((result) => {
                if (result.isConfirmed) {
                    // API endpointinde bilerek türkçe karakter değişikliği yapmadım
                    $.post('/hedeflerim/sil/' + goalId, function (response) {
                        if (response.success) {
                            toastr.success(response.message, 'Başarılı');
                            setTimeout(function () { window.location.href = '/hedeflerim'; }, 1000);
                        } else {
                            toastr.error(response.message, 'Hata');
                        }
                    });
                }
            });
        });
    </script>
}